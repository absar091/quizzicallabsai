<!DOCTYPE html>
<html>
<head>
    <title>Firebase Permissions Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 10px; }
        #results { margin-top: 20px; padding: 20px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>🧪 Firebase Permissions Test</h1>
    <p>This page tests Firebase database permissions after rule deployment.</p>
    
    <button onclick="testPermissions()">🚀 Test Permissions</button>
    <button onclick="clearResults()">🧹 Clear Results</button>
    
    <div id="results"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase config (you'll need to replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyBart3YOoBWb82LOeNJ6iZSfkl3wJDf3xo",
            authDomain: "quizzicallabs.firebaseapp.com",
            databaseURL: "https://quizzicallabs-default-rtdb.firebaseio.com",
            projectId: "quizzicallabs",
            storageBucket: "quizzicallabs.firebasestorage.app",
            messagingSenderId: "795131004388",
            appId: "1:795131004388:web:ca4243c99529a8c23273f1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            console.log(message);
        }

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        }

        window.testPermissions = async function() {
            log('🧪 Starting Firebase permissions test...', 'info');
            
            // Check auth state
            const user = auth.currentUser;
            if (!user) {
                log('❌ No authenticated user found. Please log in to the main app first.', 'error');
                return;
            }
            
            log(`✅ Authenticated user: ${user.uid}`, 'success');
            
            // Test 1: Quiz Results
            log('1️⃣ Testing quiz results permissions...', 'info');
            try {
                const testId = `test-${Date.now()}`;
                const quizResultRef = ref(database, `quizResults/${user.uid}/${testId}`);
                const testData = {
                    id: testId,
                    userId: user.uid,
                    topic: 'Permission Test',
                    score: 5,
                    total: 5,
                    percentage: 100,
                    date: new Date().toISOString(),
                    createdAt: Date.now()
                };
                
                await set(quizResultRef, testData);
                log('✅ Quiz result write: SUCCESS', 'success');
                
                const snapshot = await get(quizResultRef);
                if (snapshot.exists()) {
                    log('✅ Quiz result read: SUCCESS', 'success');
                    // Cleanup
                    await set(quizResultRef, null);
                    log('✅ Quiz result cleanup: SUCCESS', 'success');
                } else {
                    log('❌ Quiz result read: FAILED - No data returned', 'error');
                }
            } catch (error) {
                log(`❌ Quiz result test FAILED: ${error.message}`, 'error');
            }
            
            // Test 2: Shared Quiz
            log('2️⃣ Testing shared quiz permissions...', 'info');
            try {
                const testId = `test-${Date.now()}`;
                const sharedQuizRef = ref(database, `shared_quizzes/${testId}`);
                const testData = {
                    id: testId,
                    title: 'Permission Test Quiz',
                    ownerId: user.uid,
                    questions: [{
                        question: 'Test question?',
                        answers: ['A', 'B', 'C', 'D'],
                        correctAnswer: 'A'
                    }],
                    createdAt: Date.now(),
                    shareCode: 'TEST123'
                };
                
                await set(sharedQuizRef, testData);
                log('✅ Shared quiz write: SUCCESS', 'success');
                
                const snapshot = await get(sharedQuizRef);
                if (snapshot.exists()) {
                    log('✅ Shared quiz read: SUCCESS', 'success');
                    // Cleanup
                    await set(sharedQuizRef, null);
                    log('✅ Shared quiz cleanup: SUCCESS', 'success');
                } else {
                    log('❌ Shared quiz read: FAILED - No data returned', 'error');
                }
            } catch (error) {
                log(`❌ Shared quiz test FAILED: ${error.message}`, 'error');
            }
            
            log('🎉 Firebase permissions test completed!', 'info');
        }

        // Monitor auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                log(`🔐 User authenticated: ${user.uid}`, 'success');
            } else {
                log('🔐 No user authenticated. Please log in to the main app.', 'info');
            }
        });
    </script>
</body>
</html>