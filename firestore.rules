// ğŸ”¥ Quiz Arena - Live Multiplayer Quiz Security Rules v2
// Copy and paste this entire file to your Firebase Firestore Security Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ”’ Quiz Rooms - Core game state management
    match /quiz-rooms/{roomId} {

      // âœ… Anyone can read rooms to join & sync (for public rooms & joining)
      allow read: if true;

      // âœ… Only authenticated users can create rooms (as host)
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.hostId;

      // âœ… Host can update room state (start, next question, finish)
      // They can only update specific fields and must be the host
      allow update: if request.auth != null &&
        request.auth.uid == resource.data.hostId;

      // âŒ Host cannot delete rooms (prevents griefing)
      allow delete: if false;
    }

    // ğŸ® Quiz Players - Subcollection for managing players in each room
    match /quiz-rooms/{roomId}/players/{userId} {

      // âœ… Anyone can read player list (for leaderboard)
      allow read: if true;

      // âœ… Authenticated players can join (only their own entry)
      // Allow create for authenticated users trying to join
      allow create: if request.auth != null;

      // âœ… Players can ONLY update their own score and join info
      allow update: if request.auth != null &&
        request.auth.uid == userId;

      // âŒ No deletions (players stay in room until game ends)
      allow delete: if false;
    }

    // ğŸ“ Quiz Answers - Secure answer submission system
    match /quiz-rooms/{roomId}/answers/{answerId} {

      // âœ… Anyone can read answers (for leaderboard calculations)
      allow read: if true;

      // âœ… ONLY the authenticated user can submit their own answers
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId &&
        // Answer must contain required fields
        request.resource.data.keys().hasAll([
          'userId', 'questionIndex', 'answerIndex', 'submittedAt'
        ])$');

      // âŒ No updates or deletions (answers are immutable)
      allow update, delete: if false;
    }

    // ğŸ›¡ï¸ Server Validated Answers (for anti-cheat)
    match /quiz-rooms/{roomId}/validated-answers/{answerId} {
      // Only readable by room participants for leaderboard
      allow read: if true;
      // Only created by Cloud Function (server-side)
      allow create: if false;
      allow update, write: if false;
    }

    // ğŸ¯ Quiz Discovery - Public rooms and system collections
    match /quiz-rooms {
      // âœ… Only read access for discovery
      allow read: if true;

      // ğŸ”’ No write access to root collection
      allow write: if false;
    }

    // ğŸ›¡ï¸ System collections (for future features)
    match /system/{document} {
      // ğŸ”’ System-only access
      allow read, write: if false;
    }

    // ğŸ”¥ FCM Tokens - For push notifications
    match /fcmTokens/{userId} {
      // âœ… Users can read/write their own FCM tokens
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ“± Device Tracking - For security notifications
    match /deviceTracking/{userId} {
      // âœ… Users can read/write their own device tracking data
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ” Login Notifications - For security alerts
    match /loginNotifications/{notificationId} {
      // âœ… Anyone can read notifications (for email delivery)
      allow read: if true;
      // âœ… Authenticated users can create their own notifications
      allow create: if request.auth != null;
      // âŒ No updates or deletions (immutable once created)
      allow update, delete: if false;
    }

    // ğŸ”‘ Login Credentials - For device tracking and security
    match /loginCredentials/{userId} {
      // âœ… Users can read/write their own login credentials
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ›¡ï¸ Security Logs - For audit trails
    match /securityLogs/{logId} {
      // âœ… Users can read their own security logs
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // âœ… Users can create security log entries
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // âŒ No updates or deletions (immutable audit trail)
      allow update, delete: if false;
    }

    // ğŸ‘¤ User profiles and email verification
    match /users/{docId} {
      // âœ… Users can read/write their own profile (by UID)
      allow read, write: if request.auth != null && request.auth.uid == docId;
      // âœ… Allow read/write for email verification (by email as docId)
      // Server-side Firebase Admin SDK bypasses these rules anyway
      allow read, write: if true;
    }

    // ğŸ’¬ Quiz results (existing from quiz feature)
    match /quiz-results/{document} {
      // Your existing quiz results rules
      allow read, write: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Keep as read-only for public access to shared quizzes
    match /shared-quizzes/{document} {
      allow read: if true;
    }

    // ğŸ•’ Default deny-all rule for any other collections
    match /{document} {
      allow read, write: if false;
    }
  }


}
